#!/bin/bash

# Pre-push hook for Bisq Mobile
# Runs ktlint check and unit tests before allowing push

echo "üîç Running pre-push checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Find repository root to handle pushes from subdirectories
REPO_ROOT=$(git rev-parse --show-toplevel)

# Read coverage thresholds from gradle.properties
COVERAGE_THRESHOLD=$(grep "kover.coverage.minimum" "$REPO_ROOT/gradle.properties" | cut -d'=' -f2)
if [ -z "$COVERAGE_THRESHOLD" ]; then
    echo "Error: kover.coverage.minimum property not found in gradle.properties"
    exit 1
fi

DIFF_COVERAGE_THRESHOLD=$(grep "kover.diff.coverage.minimum" "$REPO_ROOT/gradle.properties" | cut -d'=' -f2)
if [ -z "$DIFF_COVERAGE_THRESHOLD" ]; then
    echo "Error: kover.diff.coverage.minimum property not found in gradle.properties"
    exit 1
fi

# ============================================
# REUSABLE FUNCTIONS
# ============================================

# Handles ktlint check failures (both violations and build errors)
# Parameters: $1 = exit code, $2 = ktlint output, $3 = files source type
handle_ktlint_failure() {
    local exit_code=$1
    local ktlint_output="$2"
    local files_source="$3"

    if [ $exit_code -ne 0 ]; then
        # Check if there are actual ktlint violations (not compilation errors)
        violations=$(echo "$ktlint_output" | grep -E "\.kts?:[0-9]+:[0-9]+" | grep -v "file://" | grep -v "^[ew]:")

        if [ -n "$violations" ]; then
            # Actual ktlint violations found
            echo ""
            print_error "ktlint found violations!"
            echo ""
            echo "Violations found:"
            echo "$violations" | head -20
            echo ""
            echo ""

            # Offer auto-fix
            printf "Attempt auto-fix? (y/n): "
            exec < /dev/tty
            read -r response
            exec <&-

            if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
                echo ""
                echo "üîß Running ktlintFormat..."

                # Execute format command based on source type and capture output
                if [ "$files_source" = "changed_files" ]; then
                    format_output=$(./gradlew --quiet ktlintFormat -PinternalKtlintGitFilter="$CHANGED_FILES" -Pkotlin.native.ignoreDisabledTargets=true 2>&1)
                else
                    format_output=$(./gradlew --quiet ktlintFormat -Pkotlin.native.ignoreDisabledTargets=true 2>&1)
                fi
                format_exit_code=$?

                if [ $format_exit_code -eq 0 ]; then
                    echo ""
                    print_success "Files formatted successfully!"
                    echo ""

                    # Show which files were modified
                    files_modified=$(git diff --name-only | grep "\.kts\?$")

                    if [ -n "$files_modified" ]; then
                        echo "üìã Modified files:"
                        echo "$files_modified" | while read -r file; do
                            echo "  ‚Ä¢ $file"
                        done
                        echo ""
                    fi

                    print_warning "Push aborted. Please review the changes, commit, and push again."
                    echo ""
                    echo "Next steps:"
                    echo "  1. Review changes:  git diff"
                    echo "  2. Stage files:     git add <files>"
                    echo "  3. Commit:          git commit --amend --no-edit  (or create new commit)"
                    echo "  4. Push again:      git push"
                    echo ""
                    exit 1
                else
                    echo ""
                    print_error "Auto-fix failed. Some violations cannot be fixed automatically."
                    echo ""

                    # Try to extract report file path from output
                    report_path=$(echo "$format_output" | grep -oE "/[^[:space:]]+\.txt" | head -1)

                    if [ -n "$report_path" ]; then
                        echo "See detailed violations report:"
                        echo "  $report_path"
                        echo ""
                    fi

                    echo "Please fix these violations manually and try again."
                    echo ""
                    exit $format_exit_code
                fi
            else
                echo ""
                print_error "Push aborted due to ktlint violations"
                echo ""
                echo "Next steps:"
                echo "  # Fix all violations:"
                echo "  ./gradlew ktlintFormat"
                echo ""
                echo "  # Or fix only files changed in your branch (replace <base-branch> with your actual base):"
                echo "  ./gradlew ktlintFormat -PinternalKtlintGitFilter=\"\$(git diff --name-status <base-branch (e.g: upstream/main)>...HEAD | awk '\$1 != \"D\" && \$NF ~ /\\.kts?$/ { print \$NF }')\""
                echo ""
                echo "  # Then stage and commit (amend or new commit - your choice):"
                echo "  git add <files>"
                echo "  git commit"
                echo ""
                echo "Or push anyway with: git push --no-verify"
                echo ""
                exit $exit_code
            fi
        else
            # No ktlint violations found, but task failed (likely compilation error)
            echo ""
            print_error "Build failed (not a ktlint issue)"
            echo ""
            echo "The ktlint check failed due to compilation errors or other build issues."
            echo "Please fix the errors and try again."
            echo ""
            echo "To see full error output:"
            echo "  ./gradlew ktlintCheck"
            echo ""
            exit $exit_code
        fi
    fi
}

# ============================================
# 1. KTLINT CHECK (files changed in branch)
# ============================================
echo "üé® Running ktlint check on branch changes..."

# Detect base branch with fallbacks
if git rev-parse --verify upstream/main >/dev/null 2>&1; then
    BASE_BRANCH="upstream/main"
else
    echo ""
    print_warning "No base branch found (tried upstream/main)"
    print_warning "Running ktlint on entire project instead"
    echo ""
    BASE_BRANCH=""
fi

# Determine which files to check
if [ -n "$BASE_BRANCH" ]; then
    # Get Kotlin files changed in this branch (excluding deleted files)
    CHANGED_FILES="$(git diff --name-status $BASE_BRANCH...HEAD | awk '$1 != "D" && $NF ~ /\.kts?$/ { print $NF }')"

    if [ -z "$CHANGED_FILES" ]; then
        echo "No Kotlin files changed in this branch."
        echo ""
    else
        echo "Checking Kotlin files changed in this branch (compared to $BASE_BRANCH):"
        echo "$CHANGED_FILES"
        echo ""
        echo "‚è≥ Running ktlint (this may take a moment)..."

        ktlint_output=$(./gradlew ktlintCheck -PinternalKtlintGitFilter="$CHANGED_FILES" -Pkotlin.native.ignoreDisabledTargets=true 2>&1)
        gradle_command_exit_code=$?

        echo "‚úì Completed ktlint run."

        # Handle failures using shared function
        handle_ktlint_failure $gradle_command_exit_code "$ktlint_output" "changed_files"

        print_success "ktlint check passed!"
        echo ""
    fi
else
    # No base branch found - run ktlint on entire project
    echo "Checking all Kotlin files in project..."
    echo ""
    echo "‚è≥ Running ktlint on entire project (this may take a while)..."

    ktlint_output=$(./gradlew ktlintCheck -Pkotlin.native.ignoreDisabledTargets=true 2>&1)
    gradle_command_exit_code=$?

    echo "‚úì Completed ktlint run."

    # Handle failures using shared function
    handle_ktlint_failure $gradle_command_exit_code "$ktlint_output" "all_files"

    print_success "ktlint check passed!"
    echo ""
fi

# ============================================
# 2. RUN UNIT TESTS & CODE COVERAGE
# ============================================
echo "üß™ Running unit tests with coverage verification..."
./gradlew testDebugUnitTest koverVerify -q

if [ $? -ne 0 ]; then
    echo ""
    print_error "Tests failed or coverage is below the required threshold!"
    echo ""
    echo "To see test details, run:"
    echo "  ./gradlew testDebugUnitTest"
    echo ""
    echo "To view HTML test reports:"
    echo "  open */build/reports/tests/testDebugUnitTest/index.html"
    echo ""
    echo "To see detailed coverage report:"
    echo "  ./gradlew koverHtmlReport"
    echo "  open build/reports/kover/html/index.html"
    echo ""
    echo "Note: The project requires a minimum of ${COVERAGE_THRESHOLD}% overall coverage."
    echo ""
    echo "To skip this check (not recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

print_success "All unit tests passed and coverage meets baseline (‚â•${COVERAGE_THRESHOLD}%)!"
echo ""
echo "‚ÑπÔ∏è  Note: PRs must also meet ${DIFF_COVERAGE_THRESHOLD}% diff coverage (checked in CI)"
echo "   To check diff coverage locally before pushing:"
echo "   pip3 install diff-cover==10.2.0  # or: python3 -m pip install diff-cover==10.2.0"
echo "   ./gradlew koverXmlReport"
echo "   bash << 'COVERAGE_EOF'"
echo "     SRC_ROOTS=()"
echo "     while IFS= read -r dir; do SRC_ROOTS+=(\"\$dir\"); done < <(find . -type d -path \"*/src/*/kotlin\" -not -path \"*/build/*\" | sed 's|^\\./||')"
echo "     mkdir -p build/reports/diff-cover"
echo "     diff-cover build/reports/kover/report.xml --compare-branch=upstream/main --fail-under=${DIFF_COVERAGE_THRESHOLD} \\"
echo "       --html-report build/reports/diff-cover/diff-coverage.html --src-roots \"\${SRC_ROOTS[@]}\""
echo "   COVERAGE_EOF"
echo "   open build/reports/diff-cover/diff-coverage.html  # Opens the visual HTML report"
echo ""

# Success!
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
print_success "All pre-push checks passed! üöÄ"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

exit 0
